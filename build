#!/usr/bin/env bash
set -euxo pipefail

die() { echo "$@" 1>&2 ; exit 1; }

if command -v node >/dev/null; then
    NODE="node"
elif command -v nodejs >/dev/null; then
    NODE="nodejs"
else
	die "Nodejs is required. Not found in path"
fi

BDIR=temp
DEST=lib
SRC=src
CC=bin/rapydscript

declare -A source_code

CHANGED=0
FILES=("baselib" "utils" "ast" "parse" "output")
for i in ${FILES[@]}; do
	if [[ $SRC/$i.pyj -nt $DEST/$i.js ]]; then
		CHANGED=1;
	fi
done

if [[ "$1" == "--force" ]]; then CHANGED=1; fi

if [[ $CHANGED -eq 0 ]]; then
	echo "Up to date"
	exit 0
fi

FLAGS="-b -p -N -m"
EXTRA_FLAGS=""
rm -rf $BDIR
mkdir $BDIR || die "Failed to create $BDIR directory"
for i in ${FILES[@]}; do
	if [[ "$i" == "baselib" ]]; then 
		EXTRA_FLAGS="-B"; 
	else
		EXTRA_FLAGS="";
	fi
	$NODE $CC $SRC/$i.pyj -o $BDIR/$i.js $FLAGS $EXTRA_FLAGS || die "Failed to compile $i"
done

cp $BDIR/*.js $DEST/ && exit 0
